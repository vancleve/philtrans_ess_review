\documentclass[11pt]{article}

\usepackage[style=prsb,natbib=true,uniquename=false,uniquelist=false,sortcites=false,sorting=oldnone]{biblatex}
\addbibresource{refs.bib}

\DeclareSortingTemplate{oldnone}{
  \sort{\citeorder}
}

\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{array}
\usepackage[letterpaper]{geometry}
\geometry{hmargin={1in,1in},vmargin={0.7in,0.7in}}

\usepackage[hidelinks]{hyperref}
\usepackage[inline]{enumitem}
\newlist{ilnum}{enumerate*}{1}
\setlist[ilnum]{ label=(\Roman*) }

\usepackage{amsmath}
\usepackage{amsthm,amssymb}
\usepackage{mleftright}
\mleftright


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% XeLaTeX font settings
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}
\usepackage{unicode-math}

\setmainfont{Minion Pro}
\setsansfont[Scale=MatchLowercase]{Myriad Pro}
\setmonofont[Scale=MatchLowercase]{Fira Code}
\setmathfont[Scale=MatchLowercase]{TeX Gyre Pagella Math}
\setmathfont[range=up/{num,latin,Latin,greek,Greek}]{Minion Pro}
\setmathfont[range=it/{latin,Latin,greek,Greek}]{MinionPro-It}
\setmathfont[range=bfup/{latin,Latin,greek,Greek}]{MinionPro-Bold}
\setmathfont[range=bfit/{latin,Latin,greek,Greek}]{MinionPro-BoldIt}
\setmathfont[range=\mathcal]{Asana Math}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[explicit]{titlesec}
\titleformat{\section}        {\large \bfseries \scshape}{\thesection.}{1ex}{#1}
\titleformat{\subsection}     {\bfseries \itshape}{\thesubsection.}{1ex}{#1}
\titleformat{\subsubsection}  [runin]{\bfseries}{\thesubsubsection.}{1ex}{#1}

\titlespacing{\section}       {0pt}{1.5ex plus 0.5ex minus 0.5ex}{0.5ex plus 0.5ex minus 0.5ex}
\titlespacing{\subsection}    {0pt}{1.5ex plus 0.5ex minus 0.5ex}{0.0ex plus 0.25ex minus 0.25ex}
\titlespacing{\subsubsection} {0pt}{1.5ex plus 0.5ex minus 0.5ex}{1em}

\usepackage{setspace}
\usepackage{titling}
\usepackage{xparse}

\usepackage[mathlines]{lineno}
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
  \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
  \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
  \renewenvironment{#1}%
     {\linenomath\csname old#1\endcsname}%
     {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
  \patchAmsMathEnvironmentForLineno{#1}%
  \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}

\usepackage{tikz}
\usetikzlibrary{arrows}

%%% new commands and macros

\newcommand{\der}{\mathop{}\!\mathrm{d}}
\newcommand{\Oh}[1]{O\left(#1\right)}
\newcommand{\ExpectationOperator}{\mathrm{E}}
\NewDocumentCommand \E {d[] d()} {%
  \IfNoValueTF {#1} {%
    \IfNoValueTF {#2} {%
      \mathop{\kern0pt\ExpectationOperator}\nolimits%
    }{%
      \mathop{\kern0pt\ExpectationOperator}\nolimits\left(#2\right)%
    }}{%
    \IfNoValueTF {#2} {%
      \mathop{\kern0pt\ExpectationOperator#1}\nolimits%
    }{%
      \mathop{\kern0pt\ExpectationOperator#1}\nolimits\left(#2\right)%
    }%
  }
}
\DeclareMathOperator{\Var}{Var}
\DeclareMathOperator{\Cov}{Cov}
\newcommand{\Fst}{F_{\mathrm{ST}}}
\newcommand{\mean}[1]{\overline{#1}}
\newcommand{\w}{w}
\newcommand{\ess}[1]{#1^*}
\newcommand{\fixp}[1]{\hat{#1}}
\renewcommand{\vec}[1]{\symbf{#1}}
\newcommand{\rec}{\rho}
\newcommand{\mut}{\mu}
\newcommand{\eig}{\lambda}
\newcommand{\numc}{c}
\newcommand{\cost}{}
\newcommand{\benefit}{}

\newtheorem{result}{Result}

\newcommand{\xaxisandtickspip}{
\begin{tikzpicture}[>=angle 90,scale=1.05]
  % x-axis
  \draw[] (0,0)--(3,0);
  % Tick marks and annotations
  %\path (1.5,-0.8) node [below]{$\mu_M$};

  \foreach \x/\nodeLabel in {0/$10^{-3}$,
    1.1115/$10^{-2}$,
    2.2231/$10^{-1}$,
    3/$0.5$}
  {
    \draw (\x,-0.1) -- (\x,0.1);
    \path[anchor=center] (\x,-0.5) node[rotate=90] {\footnotesize\nodeLabel};
  }
\end{tikzpicture}
}

\newcommand{\yaxisandtickspip}{
\begin{tikzpicture}[>=angle 90,scale=1.05]
  % y-axis
  \draw[] (0,0)--(0,3);
  % Tick marks and annotations
  %\path (-0.8,1.5) node [left]{$\mu_m$};

  \foreach \y/\nodeLabel in {0/$10^{-3}$,
    1.1115/$10^{-2}$,
    2.2231/$10^{-1}$,
    3/$0.5$}
  {
    \draw (-0.1,\y) -- (0.1,\y);
    \path[anchor=center] (-0.5,\y) node {\footnotesize\nodeLabel};
  }
\end{tikzpicture}
}

%%%

\begin{document}

\begin{titlingpage}
\setlength{\droptitle}{2em}
\pretitle{\begin{center}\LARGE}
\posttitle{\par\end{center}\vskip 2.5em}

\title{\scshape Evolutionarily stable strategy analysis and its links to demography and genetics through invasion fitness}
\author{Jeremy Van Cleve}
\date{}
\maketitle

\vfill

\noindent
Department of Biology\\
University of Kentucky\\
Lexington, KY 40506 USA\\[1em]
phone: 859-218-3020\\
fax: 859-257-1717\\[1em]
e-mail: \href{mailto:jvancleve@uky.edu}{jvancleve@uky.edu}

\vspace{2em}

\begin{flushright} \textit{Date modified: \today} \end{flushright}
\end{titlingpage}

\linenumbers
\onehalfspacing
\begin{abstract}

  Evolutionarily stable strategy (ESS) analysis pioneered by Maynard Smith and Price took off in part because it often does not require explicit assumptions about the genetics and demography of a population in contrast to population genetic models. Though this simplicity is useful, it obscures the degree to which ESS analysis applies to populations with more realistic genetics and demography: for example, how does ESS analysis handle complexities such as kin selection, group selection, and variable environments when phenotypes are affected by multiple genes?

  In this paper, I review the history of the ESS concept and show how early uncertainty about the method lead to important mathematical theory linking ESS analysis to general population-genetic models. I use this theory to emphasize the link between ESS analysis and the concept of ``invasion fitness''. I give examples of how invasion fitness can measure kin selection, group selection, and the evolution of linked modifier genes in response to variable environments. The ESSs in these examples depend crucially on demographic and genetic parameters, which highlights how ESS analysis will continue to be an important tool in understanding evolutionary patterns even as models must address the increasing abundance of genetic and long-term demographic data in natural populations.

\end{abstract}

\vspace{3em}
\noindent {\bfseries Key words}\\
ESS, lineage fitness, kin selection, group selection, reduction principle, variable environments

\clearpage
\section{Introduction}

Although Richard Lewontin was the first to introduce game theory into biology in 1961 \cite{Lewontin:1961}, very few papers on the topic of game theory and biology were published in the following decade. It wasn't until 1973 when John Maynard Smith and George Price introduced the evolutionarily stable strategy (ESS) and applied it to the study of animal behavior \cite{Maynard-Smith:Price:1973} that biologists more widely came to appreciate the relevance and utility of game theoretic concepts and tools for questions in evolution biology and ecology. Specifically, Maynard Smith and Price posited that individual fitness could be viewed as an analog of the game-theoretic notion of ``utility'', which is the quantity that measures what agents optimize in pursuit of their objectives \cite{Myerson:1991}. Viewed this way, the ESS is a refinement of the famous Nash equilibrium \cite{Nash:1950}. Maynard Smith explained the ESS concept in more detail in an important paper in 1974 \cite{Maynard-Smith:1974}, introduced the famous ``Hawk-Dove'' game in his study of asymmetric games in 1976 \cite{Maynard-Smith:Parker:1976}, and summarized the nascent field of evolutionary game theory in his now classic 1982 book \cite{MaynardSmith:1982}. In the 50 years since the 1973 paper, evolutionary game theory has become an essential tool in evolutionary and behavioral ecology and includes rich theoretical work that delves into foundational evolutionary and game-theoretic concepts and mathematical and simulation models that predict ESSs for many specific biological systems. Evolutionary game theory has also strongly influenced the social sciences including, economics, political science, psychology, and anthropology and has drawn applied mathematicians, computer scientists and physicists into mathematical biology.

The role of evolutionary game theory and the ESS method specifically in evolutionary biology has been at the crux of some of the most important conceptual debates in the field including the role of natural selection and adaptation vis-a-vis other evolutionary forces \cite[e.g.,][]{MaynardSmith:1978,Gould:Lewontin:1979,Lewontin:1979,Orzack:Sober:1994,Gardner:2017,Kern:Hahn:2018,Jensen:Payseur:2019} and the importance of kin and group selection relative to individual selection
\cite[e.g.,][]{Hamilton:1963,Maynard-Smith:1964,Price:1972:cov,Wilson:Wilson:2007,Leigh:2010,Akcay:VanCleve:2012,West:Griffin:2007,Gardner:Grafen:2009,Nowak:Tarnita:2010,Abbot:Abe:2011,Allen:Nowak:2013,Birch:2014,Birch:2017,Nowak:McAvoy:2017}. These debates might be captured in part by the following two questions: \begin{ilnum} \item \label{q:I} How do ESS models that focus on individual fitness capture the effects of kin selection or group selection? \item \label{q:II} How do ESS models account for recombination, mutation, migration, and other evolutionary forces? \end{ilnum} In this work, I will describe how conceptual advances in evolutionary theory since Maynard Smith and Price \cite{Maynard-Smith:Price:1973} have shed light on both of these questions and have led to a broader understanding of the ESS method and a more integrative framework for understanding how multiple evolutionary forces in complex populations can lead to diverse phenotypes.

Question \ref{q:I} derives in part from how Maynard Smith introduced his work on ESSs; he argued that an ESS could provide an explanation for the evolution of behaviors where ``selection acts entirely at the individual level, but in which the success of any particular strategy depends on what strategies are adopted by other members of the population'' \cite[p. 210]{Maynard-Smith:1974} and is not ``due to group or species selection'' \cite[p. 15]{Maynard-Smith:Price:1973} or selection on ``close relatives'' \cite[p. 210]{Maynard-Smith:1974} as might be the case for kin selection \cite{Hamilton:1964}. In setting up this dichotomy, Maynard Smith implied that the ESS method may not apply when kin or group selection are involved. As I will describe below, evolutionary theorists have since realized (including Maynard Smith himself \cite[p. 33]{MaynardSmith:1978}) that the ESS method is really orthogonal to issues of individual vs. group vs. kin selection and instead captures in what sense evolution via natural selection optimizes fitness given a specific measure of fitness. Issues of individual vs. group vs. kin selection are about the ``units'' or ``levels'' at which selection acts and how fitness should be measured to account for selection at those levels. Lewontin also hints at the levels of selection question in his 1961 game theory paper when he discusses the relative merits of individual-level measures of fitness like intrinsic or Malthusian growth rate $r$ versus population-level measures like mean fitness $\mean{w}$ \cite[pp. 400-401]{Lewontin:1961} as analogs of utility. The levels of selection question became a major topic of study in evolutionary theory \cite[e.g.,][]{Lewontin:1970,Dawkins:1982,Wilson:Sober:1989,Maynard-Smith:Szathmary:1995,Wilson:1997,Michod:1999,Michod:2006,Szathmary:2015} and philosophy of biology \cite{Hull:1980,Brandon:1982,Damuth:Heisler:1988,Lloyd:1992,Lloyd:1994,Sober:Wilson:1994,Okasha:2006,Okasha:2016} and continues to generate substantial research \cite[e.g.,][]{Black:Bourrat:2020,Cooney:Mori:2022,Veit:2022}. For the purpose of explaining how an ESS can capture selection at multiple levels and among relatives or kin, I will argue below that the right measure of utility is the ``invasion fitness'' \cite{Metz:Nisbet:1992,Heino:Metz:1998} or ```lineage fitness'' \cite{Lehmann:Alger:2015,Akcay:VanCleve:2016,Lehmann:Mullon:2016} of a mutant allele at a single genetic locus, which can be shown to be functionally equivalent to a measure of inclusive fitness \cite{Lehmann:Mullon:2016,Lehmann:Rousset:2020}, which is a concept originally proposed by W.D. Hamilton in relation to kin selection \cite{Hamilton:1964}.

The origin of question \ref{q:II} rests in a different set of debates in evolutionary biology regarding the relative role of natural selection vis-a-vis other evolutionary forces, such as mutation, recombination, and migration, in explaining organismal phenotypes. Early in the 20th century, R. A. Fisher's ``fundamental theorem of natural selection'' (FTNS) \cite{Fisher:1930} established a mathematical expression of the importance of natural selection. The FTNS states that the increase in the mean fitness of a population is equal to the genetic variance in fitness and thus seems to imply that populations always become better adapted to their environments (since genetic variance is always non-negative) and even that fitness is maximized over the long term. It is hard to overstate the importance of the FTNS in shaping the direction of evolutionary theory. The FTNS came to typify the idea that evolutionary change is dominated by natural selection as a fitness optimizing force. Hamilton appealed to this idea in his original paper on kin selection \cite{Hamilton:1964} and theorized that inclusive fitness is the fitness quantity that is maximized.

Subsequent work by population geneticists revealed the weakness of this understanding of the FTNS by showing that mean fitness can decrease due to frequency-dependent selection \cite{Wright:1955,Lewontin:1970} or recombination among multiple genetic loci \cite{Kojima:Kelleher:1961,Moran:1964,Karlin:1975,Akin:1979}. Further, studies in the 1960s of the rates of molecular evolution \cite{Zuckerkandl:Pauling:1965,King:Jukes:1969} and levels of polymorphism \cite{Harris:1966,Lewontin:Hubby:1966} in a number of species spurred the development of the neutral \cite{Kimura:1968,Kimura:1983:book} and nearly neutral \cite{Ohta:1974,Ohta:1992} theories \cite{Ohta:Gillespie:1996} of molecular evolution. These theories posited that many mutations are only weakly affected by natural selection, and thus their fate is governed mostly by genetic drift \cite{Kimura:1983:book}. Consequently, by the 1970s, evolutionary biologists were heavily debating the relative role of natural selection versus other forces in shaping evolutionary patterns \cite{Gillespie:Langley:1974,Gillespie:1978}, and some biologists including Lewontin specifically questioned the importance of fitness maximization \cite{Karlin:1975,Gould:Lewontin:1979}. Maynard Smith was a clear proponent of fitness maximization and viewed it natural to ``[assume] that evolution has occurred by natural selection'' \cite[p. 31]{MaynardSmith:1978}. He proposed the ESS method developed by Price and himself as the appropriate tool for predicting phenotypic evolution and particularly for social traits. While Maynard Smith acknowledged that ESS models make a number of biological assumptions including that traits have a simple genetic basis and that appropriate genetic variation exits \cite{MaynardSmith:1978}, he believed that the limitations imposed by these assumptions are biologically reasonable. This view that simplifying away genetic complexities or constraints is generally reasonable was termed the ``phenotypic gambit'' by Alan Grafen \cite{Grafen:1984} and came to dominate evolutionary theory in behavioral and evolutionary ecology \cite{Houston:McNamara:1999}. The near-singular focus of evolutionary game theory and the ESS method on natural selection has become less defensible given the recent and increasing abundance of genomic and transcriptomic data for a diverse set of species \cite[e.g.,][]{Kapheim:Pan:2015,Mikheyev:Linksvayer:2015,Warner:Mikheyev:2017,Kocher:Mallarino:2018,Warner:Mikheyev:2019}; specifically, some have argued that understanding these data requires moving beyond the gambit with more explicit consideration of complex genetic and demographic mechanisms \cite[e.g.,][]{Springer:Crespi:2011,Rittschof:Robinson:2014,Akcay:Linksvayer:2015,Cunningham:2020}. Question \ref{q:II} arises here and asks whether the ESS method can be modified to accommodate other evolutionary forces such as mutation and recombination. I will argue below that the ESS method is more general than originally imagined by Maynard Smith and Price \cite{Maynard-Smith:Price:1973} in that in can in fact be incorporated into an evolutionary framework where natural selection and other evolutionary forces combine to shape the short and long-term evolution of traits.

\section{What is an ESS?}

The definition of an ESS is relatively simple and only involves a set of phenotypes, a measure of fitness, and a stability condition. Suppose that two individuals interact and the phenotypes that characterize their behavior in the interactions are measured with the variables $x$ and $y$. The phenotypes can be drawn from a set of discrete or continuous set of values that represents a single trait like body size or propensity to cooperate. For the purpose of explaining the theory more concretely, assume that individuals can choose one of two possible behaviors in the interaction, $C$ and $D$. The phenotypes $x$ and $y$ measure the probability that individuals in an interaction with those phenotypes choose behavior $C$, and $1-x$ and $1-y$ are the probabilities those individuals choose behavior $D$ instead (probabilistic phenotypes are called mixed strategies in game theory \cite{Osborne:Rubinstein:1994}). For example, the behavior $C$ could be cooperation in the interaction and $D$ could be a lack of cooperation. Let $\w(x,y)$ be the fitness that an individual with phenotype or strategy $x$ receives when interacting with an individual with phenotype or strategy $y$. Fitness $\w$ for the moment is simply the survival rate (i.e., viability selection) but as we'll see we can define much more general fitness measures. The stability condition \cite{Maynard-Smith:Price:1973,Maynard-Smith:1974} says that a phenotype $\ess{x}$ is an ESS, or is evolutionarily stable (ES), when no alternative strategy $y$ can improve upon the fitness that $\ess{x}$ receives when interacting with itself:
\begin{subequations}
  \label{eq:ess:def}
\begin{equation}
  \label{eq:ess:def:a}
  \w(\ess{x}, \ess{x}) \ge \w(y, \ess{x})
\end{equation}
for all phenotypes $y$. In the case that the strategy $y$ gets the same fitness interacting with $\ess{x}$ as $\ess{x}$ does with itself (equation \eqref{eq:ess:def:a} holds as an equality) then $\ess{x}$ must do better interacting with $y$ than $y$ does with itself:
\begin{equation}
  \label{eq:ess:def:b}
  \w(\ess{x}, y) > \w(y, y)
\end{equation}
\end{subequations}
The two conditions in \eqref{eq:ess:def} are equivalent to requiring that phenotype $\ess{x}$ receives higher average fitness than any alternative phenotype $y$ when $y$ is rare in the population \cite{Maynard-Smith:1974,Bishop:Cannings:1976}. If condition \eqref{eq:ess:def} holds as a strict inequality when $y \ne \ess{x}$, then $\ess{x}$ is a ``strict'' ESS.

\section{How is ESS related to population-genetic dynamics?}

Notably, the conditions in \eqref{eq:ess:def} do not reference the genetic basis of the trait $x$ nor do they describe how the frequency or mean value of the trait changes over time. Population genetics models, on the other hand, are built to measure the dynamical process of evolution via the combined effects of natural selection and segregation, recombination, mutation, genetic drift, and other evolutionary forces \cite{Crow:Kimura:1970,Ewens:2004}. A natural question then is how the long-run behavior of a population genetic model (e.g., its equilibrium genotypes and induced phenotypes) compares to the equilibrium phenotypes obtained from an analogous ESS model. This question was tackled by mathematical population biologists beginning in the late 1970s and through 1980s and 1990s \cite[e..g,][]{Taylor:Jonker:1978,Hofbauer:Schuster:1979,Zeeman:1980,Eshel:1982,Hofbauer:Schuster:1982,Cressman:Hines:1984,Eshel:Feldman:1984,Lessard:1984,Cressman:1988,Cressman:Hofbauer:1996,Eshel:1996,Hammerstein:1996,Weissing:1996}.

Early mathematical analyses began by using the simplest population genetic model, which is one that assumes a \textit{haploid asexual} population with two genotypes, one with phenotype $x=1$ that chooses $C$ with certainty and one with phentoype $x=0$ that chooses $D$ with certainty. There are four possible interacting pairs of phenotypes in this scenario yielding four fitnesses that can be collected into a so-called payoff matrix $W$:
\begin{equation*}
  W =
  \begin{pmatrix}
    \w(1,1) & \w(1,0) \\
    \w(0,1) & \w(0,0)
  \end{pmatrix} \, .
\end{equation*}
 Suppose that $p$ measures the frequency of the phenotype $x=1$ that always chooses $C$. Pairs are assumed to form randomly according to the frequencies $p$ and $1-p$ of the two types. The equilibria of this model are either fixation of one of the two genotypes resulting in a population of individuals that always chooses $C$, $p=1$, or always choose $D$, $p=0$ or a polymorphism of both genotypes, $0 < p < 1$, resulting in a population where some choose $C$ and some choose $D$. The analogous ESS model of this scenario applies condition \eqref{eq:ess:def} to the four possible fitness values in the payoff matrix $W$ and determines which phenotype, $x=1$ or $x=0$, is ESS or whether a mixed strategy (i.e., $0 < x < 1$) is ESS. These early analyses showed that the values of $x$ that are an ESS are also values of $p$ that produce stable equilibria in the haploid asexual population genetic model \cite{Taylor:Jonker:1978,Hofbauer:Schuster:1979,Zeeman:1980,Hofbauer:Sigmund:1998}.

This correspondence between the population genetic and ESS models isn't particularly surprising since natural selection is the only evolutionary force acting in the haploid asexual model. However, a similar correspondence between ESSs and population genetic models also applies to a \textit{diploid sexual} population reproducing in discrete time where Mendelian segregation breaks up diploid genotypes every generation \cite{Eshel:1982,Lessard:1984}. For this scenario, the phenotype is controlled by a single genetic locus with $a$ possible alleles $A_{1},\ldots,A_{a}$. Diploid genotype $A_{i} A_{j}$ chooses behavior $C$ with probability $x_{ij}$ and behavior $D$ with probability $1-x_{ij}$. If there are no restrictions on the $x_{ij}$, then dominance is possible between the alleles. Like the asexual haploid model, diploid individuals interact in pairs according to their probability in the population and mating is random. Let $\vec{p} = (p_{1}, \ldots, p_{a})$ be the vector of allele frequencies for alleles $A_{1},\ldots,A_{a}$ in the parental generation. The mean phenotype or probability of choosing $C$ in the population after reproduction is then
\begin{equation*}
  x = x(\vec{p}) = \sum_{i,j} p_{i} p_{j} x_{ij} \: .
\end{equation*}
Eshel and Lessard showed \cite{Eshel:1982,Lessard:1984} that ESSs $\ess{x}$ of the payoff matrix $W$ are stably maintained in the diploid population model when those ESSs are produced by some vector of allele frequencies $\ess{\vec{p}}$ such that $\ess{x} = x(\ess{\vec{p}})$. This correspondence also holds for continuous-time diploid models \cite{Sigmund:1987,Cressman:1988,Cressman:Hofbauer:1996,Hofbauer:Sigmund:1998} and for models with multiple loci when the probability of a genotype choosing a phenotype is an additive function of effects from each locus (i.e., additive non-epistasis) \cite{Eshel:1982}.

\section{ESS and long-term evolution}
\label{sec:long-term}

An important limitation of the above results connecting ESS phenotypes $\ess{x}$ to equilibria in diploid single and multilocus population genetic models is that the genotype-phenotype map may not produce phenotypes that are ESS and thus those ESS phenotypes are unattainable in the short-term. Specifically, the $x_{ij}$ may have values so that no population composition $\vec{p}$ of alleles $A_{i}$ can produce the ESS phenotype $\ess{x}$. Moreover, as mentioned above, multilocus systems more generally (i.e., systems with non-additive interactions or epistasis) do not guarantee that genotypes with higher marginal fitness\footnote{The marginal fitness of a genotype or allele is the mean fitness of that genotype or allele among all contexts in which it occurs in the population. For example, the marginal fitness of one allele at a single diploid locus in the mean fitness of that allele in combination with all other alleles according to their frequencies.} increase in frequency, which is a requirement for the correspondence between ESS and population genetic equilibria described above \cite{Eshel:1982,Hofbauer:Sigmund:1998}. Thus, the genetic system may impose constraints on either the range of possible phenotypes or on the ability of selection to increase the frequency of high marginal fitness genotypes.

Intriguingly, Eshel, Feldman, and others discovered that these constraints might not be so important on longer term evolutionary timescales. The important idea is that the conditions under which a genetic equilibrium is stable given a fixed set of alleles or genotypes does not determine whether a new and rare allele or genotype outside of that fixed set might invade the population. When an equilibrium is stable given a fixed set of alleles or genotypes, it is called ``internally stable'' \cite{Eshel:1996}. If that equilibrium also resists invasion by new alleles or genotypes outside the fixed set, it is called ``externally stable'' \cite{Liberman:1988,Eshel:1996}. Equilibria that are internally stable may not be externally stable. For example, suppose there is heterozygote advantage in a population with two alleles at a single diploid locus. The internally stable equilibrium is a polymorphism where both alleles are present in positive frequency. However, a new allele can invade the population if it generates the original heterozygote fitness in a heterozygote with either original allele and in a homozygote with itself. Hence, the internally stable polymorphism is not externally stable. The invasion of this new allele will lead to its fixation, which is a new internally stable equilibrium that may or may not be externally stable to further invasions depending on the the genotype-phenotype map (i.e., how the genotypes $A_{i} A_{j}$ generate fitness values $w_{ij}$). Given a fixed set of genotypes, the evolution of those genotypes to an internally stable equilibrium is called ``short-term evolution'' whereas the process of new mutant invasions that move the population from one internally stable equilibrium to another is called ``long-term evolution'' \cite{Eshel:1991,Eshel:1996,Hammerstein:1996,Weissing:1996,Eshel:Feldman:1998,VanCleve:2015,VanCleve:2020} and eventually leads to an externally stable equilibrium. The process of long-term evolution assumes that mutations are infrequent enough so that a new mutation has sufficient time to either go extinct or reach a new short-term equilibrium before additional mutations occurs. Exactly how infrequent this is depends on additional parameters such as the strength of selection and the population size and requires analyzing the stochastic interaction between mutation, drift, and selection \cite{Gillespie:1991,Champagnat:2006,Champagnat:Ferriere:2006,Desai:Fisher:2007}. Long-term evolution involving sequential substitution of genotypes is sometimes called the ``streetcar process'' \cite{Hammerstein:1996} or the ``trait substitution sequence'' \cite{Metz:Nisbet:1992,Dieckmann:Law:1996,Champagnat:Ferriere:2001} and is the fundamental evolutionary model of the \textit{adaptive dynamics} approach \cite{Metz:Geritz:1996,Geritz:Kisdi:1998,Dercole:Rinaldi:2008}.

Remarkably, despite the additional complexity of the long-term process, the equilibria of the long-term evolution process, not the short-term process, are what most closely align to what is predicted by the ESS criteria in \eqref{eq:ess:def}. Eshel, Feldman, Lessard and others demonstrated that externally stable equilibria are those that generate phenotypes $\ess{x}$ that are ESS \cite{Eshel:Feldman:1984,Liberman:1988,Eshel:1996,Hammerstein:Selten:1994,Hammerstein:1996,Weissing:1996,Eshel:Feldman:1998}. Specifically, suppose that the probability of selecting between behaviors $C$ and $D$ is determined by two loci $A$ and $B$ with alleles $A_{1},\ldots,A_{a}$ and $B_{1},\ldots,B_{b}$, respectively, and with recombination rate $0<\rec\le1/2$ between the loci. The vector $\vec{p} = (\ldots,p_{ij},\ldots)$ tracks the frequencies of the chromosomes (e.g., $A_{i} B_{j}$) after selection and recombination. Individuals with diploid genotype $A_{i}B_{j}/A_{k}B_{l}$ chooses behavior $C$ with probability $x_{ijkl}$ and behavior $D$ with probability $1 - x_{ijkl}$. The mean frequency of phenotype $x$ in the population after reproduction is
\begin{equation*}
  x = x(\vec{p}) = \sum_{i,j,k,l} p_{ij} p_{kl} x_{ijkl} \, .
\end{equation*}
If we assume that the fitness function $\w(x,y)$ is linear in the phenotypes $x$ and $y$ (which is a reasonable assumption given the phenotypes are probabilities of selection among behaviors $C$ and $D$), then the mean or marginal fitness of an individual with genotype $A_{i}B_{j}/A_{k}B_{l}$ interacting with other individuals in the population according to their frequencies is $w(x_{ijkl}, x)$. Likewise, the mean fitness in the population is then
\begin{equation*}
  \mean{w} = \sum_{i,j,k,l} w(x_{ijkl}, x) p_{ij} p_{kl} = w(x, x) \: .
\end{equation*}
Now, assume that a new mutant allele $A_{\mut}$ (increasing the total number of alleles at locus $A$ to $a+1$) arrives at low frequency in a population at an internally stable equilibrium $\fixp{\vec{p}}$ with ``resident'' or wild-type mean phenotype $\fixp{x} = x(\fixp{\vec{p}})$. An individual with this new allele chooses phenotype $x$ with probability $x_{\mut jkl}$ if its genotype is $A_{\mut}B_{j}/A_{k}B_{l}$ and phenotype $y$ with probability $1 - x_{\mut jkl}$. A linear stability analysis shows that this allele will either initially increase or decrease in frequency at a geometric rate $\eig$ that is the magnitude of the largest eigenvalue of a Jacobian matrix \cite{Edelstein-Keshet:2005}. The eigenvalue $\eig$ has an associated normalized eigenvector $\vec{u}$ whose elements $u_{j}$ measure the frequency of mutant chromosomes (i.e., chromosomes $A_{\mut} B_{j}$) once the invasion process has stabilized (i.e., has reached stationarity \cite{Caswell:2006}). Eshel and Feldman \cite{Eshel:Feldman:1984,Eshel:Feldman:1998} showed that this geometric growth rate is
\begin{equation}
  \label{eq:eig:twolocus}
  \eig = \frac{w(x_{\mut}, \fixp{x})}{w(\fixp{x}, \fixp{x})}
\end{equation}
where $\eig>0$ and
\begin{equation}
  \label{eq:mut:pheno:twolocus}
  x_{\mut} = \sum_{j,k,l} u_{j} \fixp{p}_{kl} x_{\mut jkl}
\end{equation}
is the frequency of phenotype $x$ among mutant individuals once the invasion process has stabilized. Note that since the mutant allele is rare, mutant individuals can have only one mutant chromosome; the other chromosome has no mutant alleles at locus $A$ and remains at the internal equilibrium frequency $\fixp{p}_{kl}$. A sufficient condition for the equilibrium with phenotype $\fixp{x}$ to be externally stable is that $\eig < 1$ or from equation \eqref{eq:eig:twolocus}
\begin{equation*}
  w(x_{\mut}, \fixp{x}) < w(\fixp{x}, \fixp{x})
\end{equation*}
for all possible mutant $A_{\mut}$ that generate mutant phenotype $x_{\mut}$. This condition is in fact the condition for a strict ESS from \eqref{eq:ess:def} and can be used to prove that the following result for large, randomly mating, diploid populations with two-locus genetic systems \cite{Eshel:Feldman:1984,Eshel:1996,Eshel:Feldman:1998}:
\begin{result}
  \label{res:twolocus}
  Any phenotype $\fixp{x}$ generated by an externally stable equilibrium is an ESS. Moreover, if an ESS $\ess{x}$ is generated by an internally stable equilibrium $\fixp{\vec{p}}$, $\fixp{\vec{p}}$ is externally stable.
\end{result}
\noindent
Work by Liberman \cite{Liberman:1988} on more than two loci likely extends Result \ref{res:twolocus} to any finite number of loci.

An important conclusion from Result \ref{res:twolocus} is that it shows that ESSs determined by the condition \eqref{eq:ess:def} of Maynard Smith and Price \cite{Maynard-Smith:Price:1973,Maynard-Smith:1974} are stable states of the long-term evolutionary process. Assuming that long-term evolution is a reasonable model of phenotypic evolution, Result \ref{res:twolocus} demonstrates the importance of natural selection on phenotypes in determining the course of phenotypic evolution and provides a robust mathematical justification for the use of the ESS method in building phenotypic evolution models. How appropriate the long-term evolution process is as a model of phenotypic evolution depends on its assumptions, which are summarized below from the references cited above in developing Result \ref{res:twolocus}:
\begin{itemize}[nosep]
  \item Phenotypes are probabilities of selecting among \textit{two} behaviors
  \item Individuals interact in pairs that form randomly.
  \item Populations are large enough to ignore stochastic forces including genetic drift.
  \item Mutation is infrequent enough so that at most two genotypes occur at a time.
  \item Phenotypes are determined by two (or more) haploid or diploid loci.
  \item Fitness (i.e., payoff) is a linear function of phenotype.
\end{itemize}
While many natural populations deviate significantly from many if not all of the above assumptions, they may not be as restrictive as they seem for a few reasons. First, it is an open theoretical question as to whether the long-term evolution process occurs under more relaxed assumptions. Second, additional assumptions may relax some of the above assumptions in the long-term process. For example, weak selection on phenotypes allows for the analysis of nonlinear function functions and stochastic forces due to finite population effects and reveals that the ESS condition still describes the endpoints of long-term evolution \cite{Rousset:Billiard:2000,Rousset:2004,VanCleve:2015}. Finally, small enough deviations from the above assumptions may only induce small deviations from long-term evolution predictions from ESS analysis. Thus, ESS analysis might still be useful as a first approximation in more complex scenarios outside the above assumptions. The precise limits of the long-term evolution process and ESS analysis as predictive tools for phenotypic evolution remains a fruit area for future  mathematical, computational, and empirical research.

%% do I put the convergence issue here? maybe in discussion!

\section{Invasion fitness and ESSs}

While Result \ref{res:twolocus} emphasizes the role of the ESS and natural selection on phenotypes in phenotypic evolution, the external stability approach used to prove \ref{res:twolocus} reveals a more general viewpoint where ESSs can depend in important ways on the genetic and demographic parameters of a population. External stability analysis assumes that the population is at some genetic equilibrium where new mutant alleles can invade at low frequency and looks for a genetic equilibrium and its resulting phenotype that resists invasion by any mutant allele (within a set of possible phenotypic effects). Before the mathematical machinery of external stability was developed, Hamilton appreciated the conceptual importance of uninvadable phenotypes in his study of the sex ratio, and he called sex ratios that resisted invasion ``unbeatable'' phenotypes \cite{Hamilton:1967}. As we saw above, determining whether a phenotype can be unbeatable and its genetic equilibria externally stable involves calculating the magnitude of the eigenvalue $\eig$ associated with the linear dynamical system that approximates the dynamics of the mutant allele frequency when rare. The magnitude of the eigenvalue $\eig$ measures the geometric growth rate (e.g., equation \eqref{eq:eig:twolocus}) of all mutant genotypes in a population of resident genotypes. If there are multiple possible genotypes with the mutant allele, as is the case for the two-locus model in section \ref{sec:long-term} where there may be many possible alleles at the non-mutant locus, then mutant genotype fractions during the invasion process are given by the normalized right eigenvector of the linear system $\vec{u}$. Thus, $\eig$ really measures the fitness of the whole mutant genetic lineage. The growth rate $\eig$ is often called the ``invasion fitness'' \cite{Metz:Nisbet:1992,Heino:Metz:1998}\footnote{When invasion occurs at more complex attractors like cycles, the ``invasion exponent'' is used, which is $\log |\eig|$ \cite{Rand:Wilson:1994}} and sometimes called the ``lineage fitness'' \cite{Lehmann:Alger:2015,Akcay:VanCleve:2016,Lehmann:Mullon:2016,Lehmann:Rousset:2020}. In effect, the invasion or lineage fitness measures the average number of offspring copies produced by a mutant allele sampled randomly from among all the genotypes in the mutant lineage \cite{Lehmann:Mullon:2016}. Assuming that $\eig >0$, the phenotype $\ess{x}$ is unbeatable whenever
\begin{equation}
  \label{eq:unbeatable}
  \eig(y, \ess{x}) < 1 \qquad \text{for all } y \ne x \: .
\end{equation}
Regardless of the complexity of the genetics, demography, or ecology of a population, we can in principle perform an external stability analysis\footnote{This is also referred to as an ``evolutionary invasion analysis''.} and use invasion fitness to determine whether there are unbeatable phenotypes.

It should already be evident given Result \ref{res:twolocus} that the unbeatable phenotypes obtained via external stability are closely connected to phenotypes obtained via an ESS analysis using condition \eqref{eq:ess:def}. In the general case for an arbitrary genetic and demographic scenario, we assume only that we have the invasion fitness $\eig(y, \ess{x})$ of a rare mutant $y$ in the population that otherwise has mean phenotype $\ess{x}$. Starting with the condition for a strict ESS, $w(\ess{x}, \ess{x}) > w(y, \ess{x})$ for $y \ne \ess{x}$ from \eqref{eq:ess:def:a}, we can convert that condition to one in terms of ``relative fitness'' by dividing by the mean population fitness $w(\ess{x}, \ess{x})$ to obtain
\begin{equation}
  \label{eq:strict:relative}
  \frac{w(y, \ess{x})}{w(\ess{x}, \ess{x})} = \omega(y, \ess{x}) < 1 \qquad \text{for all } y \ne x
\end{equation}
where $\omega(y, \ess{x})$ is the relative fitness of a rare mutant population with mean phenotype $y$ in a population with mean phenotype $\ess{x}$. The strict ESS condition in \eqref{eq:strict:relative} using relative fitness is identical to the condition for uninvadability in condition \eqref{eq:unbeatable} using invasion fitness, which means that unbeatable or uninvadable phentoypes are strict ESSs\footnote{The relationship between invasion fitness and non-strict ESSs is more complex and depends on specific details of the genetics of the population. For example, see the section entitled ``Long-term Stability of an ESS'' in \cite{Eshel:Feldman:1998}}.

Since we can in principle calculate invasion fitness for populations with complex genetics and demography, we can obtain strict ESSs in those populations even though Result \ref{res:twolocus} may not apply. However, those ESSs will almost certainly depend on genetic and demographic parameters of the population as the invasion fitness captures the effect of genetic and demographic processes on the growth of invading mutant lineages\footnote{see also the discussion of ``evolutionary genetic stability'' in \cite[pp. 505--506]{Eshel:1996}}. For example, the ESS for the sex ratio of a population depends on the genetic structure of the population: in a large, randomly mating population, the sex ratio is 1:1 when the ratio is determined by an diploid autosomal gene \cite{Fisher:1958,Hamilton:1967,Eshel:Feldman:1982}, but it can take other values when the gene is sex-linked or the genetic system is more complex like in insects that are haplodiploid \cite{Hamilton:1967,Eshel:Feldman:1982a}. The fact that ESSs can incorporate genetic and demographic forces alongside natural selection shows that the ESS method is a more general tool than potentially originally envisioned by Maynard Smith and other proponents of the phentoypic gambit. Below, we will describe two cases that capture this flexibility: group- and class-structured populations with kin selection and populations in variable environments with bet-hedging phenotypes.

\section{Inclusive fitness, group-structured populations, and ESS}

In a populations where individuals live in groups and migration (or dispersal) is limited, individuals are more genetically related to their groupmates than to individuals in different groups \cite{Wright:1943,Wright:1951,Hamilton:1970}, which means there is a possibility for kin selection to drive the evolution of prosocial phenotypes \cite{Hamilton:1964,Rousset:2004,Lehmann:Rousset:2014}. Moreover, group structure allows for competition among groups for resources and the possibility of selection among groups favoring more prosocial groups given sufficient group integrity \cite{Hamilton:1975,Wilson:Pollock:1992,Traulsen:Nowak:2006,Gardner:West:2006,Lehmann:Rousset:2010}. In fact, the Price equation \cite{Price:1970,Price:1972:cov} can be used to show that kin and group selection perspectives on fitness both lead to the same predictions when applied to the same population model \cite{Queller:1992,Lehmann:Keller:2007,Bijma:Wade:2008,Gardner:West:2007,Marshall:2011,Akcay:VanCleve:2012}. Thus, we should expect that predicting an ESS for prosocial behavior in a group structured population by calculating invasion fitness will capture the effects of both kin and group selection. To see this, we will outline the invasion fitness analysis of this scenario performed by Lehmann and colleagues \cite{Lehmann:Mullon:2016,Lehmann:Rousset:2020}. This analysis also provides a formal justification for the intuition of Maynard Smith \cite{MaynardSmith:1978} and others that a correct fitness measure for ESS analysis is Hamilton's inclusive fitness \cite{Hamilton:1964} by showing that inclusive fitness is monotonically related to invasion fitness.

Suppose a population is composed of an infinite number of groups each containing $n$ individuals; groups can be thought as demes or patches each  equally connected to one another at some rate of migration (i.e., Wright's island model \cite{Wright:1931}). Each individual can belong to one of $\numc$ demographic classes, such as age, sex, or caste (e.g., as workers and queens in social insects). Phenotypes are produced by alleles at a single haploid genetic locus. Alleles can be pleiotropic and code for specific phenotypes for each class: phenotype $\vec{x}=(x_{1},\ldots,x_{\numc})$ where $x_{s}$ is the phenotype for class $s$. We assume that once at a genetic and demographic equilibrium with phenotype $\vec{x}$, the population stabilizes at $n_{s}$ individuals in class $s$ in each group where the group size is just the sum of all the individuals in each class or $n = \sum_{s} n_{s}$.

We introduce a mutant phenotype $\vec{y}$ at low frequency into a population where all individuals have the resident phenotype $\vec{x}$. One way to track the number of mutant individuals in the whole population is to track the number of groups with $k$ mutants. Since each individual belongs to a specific class, we actually track how many mutant individuals $k_{s}$ are in each class $s$ in a group or $\vec{k} = (k_{1},\ldots,k_{\numc})$ where $k = \sum_{s} k_{s}$. The number of possible states for $\vec{k}$ increases quickly with the group size $n$ and the number of classes $\numc$ but is finite. For simplicity of notation, we assume there is an ordering of these states so that we can use use $\vec{k}$ to index vectors and matrices below. When the mutant phenotype is rare, growth of the mutant population can be modeled using a matrix population model \cite{Caswell:2006} or multitype branching process \cite{Kimmel:Axelrod:2015} with a projection matrix $\vec{A}(\vec{y}, \vec{x}) = [a_{\vec{k}'\vec{k}}(\vec{y}, \vec{x})]$ where the $a_{\vec{k}'\vec{k}}(\vec{y}, \vec{x})$ element measures the expected number of groups with $\vec{k}'$ mutants with phenotype $\vec{y}$ that result from the reproduction occurring in a group with $\vec{k}$ mutants in a population resident for phenotype $\vec{x}$. The largest eigenvalue $\eig(\vec{y}, \vec{x})$ of the projection matrix $\vec{A}(\vec{y}, \vec{x})$ is the invasion or lineage fitness in this population and satisfies
\begin{equation}
  \label{eq:Au:eigu}
  \vec{A}(\vec{y}, \vec{x}) \vec{u}(\vec{y}, \vec{x}) = \eig(\vec{y}, \vec{x}) \vec{u}(\vec{y}, \vec{x})
\end{equation}
where the associated eigenvector $\vec{u}(\vec{y}, \vec{x})$ has elements $u_{\vec{k}}$ that measure the relative frequency of groups with $\vec{k}$ mutants when the invasion process has stabilized. The elements $a_{\vec{k}'\vec{k}}(\vec{y}, \vec{x})$ of the projection matrix can be rewritten in terms of an individual (relative) fitness function $\omega_{s'\!s\vec{k}}(\vec{y}, \vec{x})$, which measures the number of class $s'$ mutant offspring in the population in the next generation produced by a class $s$ mutant individual in a group with $\vec{k}$ mutants. Relative fitness is the right measure here since we measure offspring production after migration, density dependent survival, and all other life-cycle events. The projection matrix and fitness function are then related through the expression for the total number of class $s'$ offspring produced by a mutant individuals in a group with $\vec{k}$ mutants:
\begin{equation}
  \label{eq:a:w}
  \sum_{k'} k_{s'}' a_{\vec{k}'\vec{k}}(\vec{y}, \vec{x}) = \sum_{s} k_{s} \omega_{s'\!s\vec{k}}(\vec{y}, \vec{x}) \: .
\end{equation}
\citeauthor{Lehmann:Mullon:2016} \cite{Lehmann:Mullon:2016,Lehmann:Rousset:2020} use equation \eqref{eq:a:w} to show that the invasion (or lineage) fitness of mutant phenotype $\vec{y}$ in a resident population with phenotype $\vec{x}$ is given by
\begin{equation}
  \label{eq:eig:class}
  \eig(\vec{y}, \vec{x}) = \sum_{\vec{k},s'\!,s} \omega_{s'\!s\vec{k}}(\vec{y}, \vec{x}) q_{\vec{k},s}(\vec{y}, \vec{x})
\end{equation}
where $q_{\vec{k},s}(\vec{y}, \vec{x})$ is the probability (when the invasion process has stabilized) a randomly sampled mutant allele from the mutant lineage is in a class $s$ individual in a group with $\vec{k}$ mutants and is given by
\begin{equation*}
  q_{\vec{k},s}(\vec{y}, \vec{x}) = \frac{k_{s} u_{\vec{k}}(\vec{y}, \vec{x})}{\sum_{\vec{k},s} k_{s} u_{\vec{k}}(\vec{y}, \vec{x})} \: .
\end{equation*}
The invasion fitness expression in equation \eqref{eq:eig:class} for a group- and class-structured population is conceptually identical to the one for a single population with two-loci in equation \eqref{eq:eig:twolocus}: both expressions show that the mutant successfully invades when mutant alleles more than replace themselves when averaged across all the genetic contexts (i.e., possible alleles at other loci) and demographic contexts (i.e., possible group compositions in terms of mutant allele frequency in each class) in which the mutant lineage occurs during the invasion process.

The invasion fitness in equation \eqref{eq:eig:class} can also be expressed in terms of inclusive fitness in order to isolate the effect on fitness of mutant allele expression in the focal individual (direct effect) and in genetically related individuals (indirect effect). There are some important technical subtleties as to how this can be accomplished that we will leave out to keep the presentation simple \cite[see ``Supplement B'' in][for details]{Lehmann:Rousset:2020}. The essence of the method is the same as the one found in many analyses that derive inclusive fitness using the Price equation \cite[e.g.,][]{Queller:1992,Frank:1998,Lehmann:Keller:2006,Akcay:VanCleve:2012}: the fitness of a focal individual, here $\omega_{s'\!s\vec{k}}(\vec{y}, \vec{x})$, is decomposed into cost and benefit terms reflecting the marginal effects on fitness\footnote{Marginal effects in this context means additive effects of the phenotype on fitness and often measured with partial regression coefficients.} of expressing the mutant phenotype $y_{s}$ relative to the resident phenotype $x_{s}$. The cost term $c_{s'\!s}(\vec{y}, \vec{x})$ measures the marginal decrease in class $s'$ offspring produced by a class $s$ individual due to expression of the mutant allele in that individual. The benefit term $b_{s'\!\sigma \leftarrow s}(\vec{y}, \vec{x})$ measures the marginal increase in the number of class $s'$ offspring produced by individuals of class $\sigma$ due to the mutant allele expression by a groupmate of class $s$. The invasion fitness can then be expressed as (using an ``actor-modulated'' approach) \cite{Lehmann:Rousset:2020}
\begin{equation}
  \label{eq:eig:IF}
  \eig(\vec{y}, \vec{x}) = 1 + \sum_{s'\!,s} q_{s}(\vec{y}, \vec{x}) v_{s'}(\vec{y}, \vec{x})
  \left( - c_{s'\!s}(\vec{y}, \vec{x}) + \sum_{\sigma} b_{s'\!\sigma \leftarrow s}(\vec{y}, \vec{x}) r_{\sigma|s}(\vec{y}, \vec{x}) \right) \: ,
\end{equation}
which is the inclusive fitness \cite{Hamilton:1964} of the mutant allele. In equation \eqref{eq:eig:IF}, $r_{\sigma|s}(\vec{y}, \vec{x})$ is the genetic relatedness in a group and is the probability that a random groupmate of class $\sigma$ has the mutant allele given an individual of class $s$ has the mutant allele, $v_{s'}(\vec{y}, \vec{x})$ is the normalized reproductive value of class $s'$, and $q_{s}(\vec{y}, \vec{x})$ is the probability that a mutant individual in the invasion process is in class $s$ (see \cite{Lehmann:Rousset:2020} for technical definitions of these quantities). Equation \eqref{eq:eig:IF} shows how invasion fitness can be partitioned into the direct effects of mutant allele expression, which are cost terms, and the indirect effects, which are the benefit times relatedness terms. Thus, kin selection and the evolution of altruistic traits are easily captured with an ESS analysis of invasion fitness.

Given that previous work using the Price equation has shown that kin selection and group selection partitions of fitness are simply alternative ways of expressing genotype frequency change in a population \cite{Queller:1992,Bijma:Wade:2008,Gardner:West:2007,Marshall:2011,Akcay:VanCleve:2012}, it should be possible to rewrite invasion fitness so as to group terms that constitute between-group selection, $\omega_{G,s'\!s}(\vec{y}, \vec{x})$, and those that constitute within-group selection, $\omega_{\Delta G,s'\!s}(\vec{y}, \vec{x})$. In fact, if we apply a ``neighbor-modulated'' approach from \cite{Queller:1992,Akcay:VanCleve:2012} to the results from \cite{Lehmann:Rousset:2020}, we obtain
\begin{equation}
  \label{eq:eig:GS}
  \eig(\vec{y}, \vec{x}) = 1 + \sum_{s'\!,s} q_{s}(\vec{y}, \vec{x}) v_{s'}(\vec{y}, \vec{x})
  \left( \omega_{G,s'\!s}(\vec{y}, \vec{x}) + \omega_{\Delta G,s'\!s}(\vec{y}, \vec{x}) \right)
\end{equation}
where, dropping the dependence on $\vec{x}$ and $\vec{y}$ for ease of presentation,
\begin{equation}
  \label{eq:wg:wdeltag}
  \begin{split}
    \omega_{G,s'\!s} & = \left(b_{s'\!s \leftarrow s} - c_{s'\!s} \right) \left(\frac{1}{n_{s}} + \frac{n_{s}-1}{n_{s}} r_{s|s} \right) + \sum_{\sigma \ne s} b_{s'\!s \leftarrow \sigma} r_{\sigma|s} \\
    \omega_{\Delta G,s'\!s} & = - \left(b_{s'\!s \leftarrow s} + c_{s'\!s}\right) \frac{n_{s}-1}{n_{s}} \left( 1 - r_{s|s} \right) \: .
  \end{split}
\end{equation}
We can see immediately that if mutant allele expression is costly to the individual itself, $c_{s'\!s}>0$, helps others, $b_{s'\!s \leftarrow \sigma}>0$ for all classes $\sigma$, and the benefits outweigh the costs within a class, $b_{s'\!s \leftarrow s} - c_{s'\!s}>0$, then the mutant allele expression is positively selected by between-group selection and negatively selected by within-group selection. Since both the kin selection and group selection partitions of invasion fitness (equations \eqref{eq:eig:IF} and \eqref{eq:eig:GS}, respectively) are expressed using the same benefit, cost, and relatedness functions, a single ESS analysis using invasion can answer questions derived from both perspectives.

\section{Variable environments, recombination, and ESS}

\begin{figure}[t!]
  \small
  \begin{tabular}{r@{}r@{\hspace{-1.0ex}}c@{}c@{}c@{}c}
    & & $R=0.0$ & $R=0.05$ & $R=0.1$ & $R=0.15$ \\
    \cmidrule(lr){3-3}  \cmidrule(lr){4-4}  \cmidrule(lr){5-5} \cmidrule(lr){6-6}
    \raisebox{-0.2cm}{\rotatebox{90}{Mutant switching rate}} & \raisebox{-0.2cm}{\yaxisandtickspip} &
    \includegraphics[width=1.25in]{pip_n50_s1_0-01_s2_0-015_r_0-0.pdf} &
    \includegraphics[width=1.25in]{pip_n50_s1_0-01_s2_0-015_r_0-05.pdf} &
    \includegraphics[width=1.25in]{pip_n50_s1_0-01_s2_0-015_r_0-1.pdf} &
    \includegraphics[width=1.25in]{pip_n50_s1_0-01_s2_0-015_r_0-15.pdf} \\
    & & \xaxisandtickspip & \xaxisandtickspip & \xaxisandtickspip & \xaxisandtickspip \\
    & & \multicolumn{4}{c}{Resident switching rate}
  \end{tabular}
  \caption{Pairwise invasibility plots for the mutation rate model of \cite{Liberman:VanCleve:2011} when alternation between each of the two environments occurs every $n=50$ generations. The fitness costs of being in the wrong environments are $s_{1} = 0.01$ and $s_{2} = 0.015$ and the recombination rate between the phenotypic locus and the modifier is given above each plot. White regions are where a mutant modifier allele with a switching rate given on the horizontal axis can invade a population fixed for a modifier allele with switching rate given on the vertical axis, and black regions are where the mutant cannot invade; in other words, the leading eigenvalue of external stability matrix $\mathcal{L}_{\mathrm{ex}}$ in equation (17) of Liberman et al. \cite{Liberman:VanCleve:2011} is greater than one in the white regions and less than one in the black regions.}
  \label{fig:pip:switching}
\end{figure}

One of the important features of Result \ref{res:twolocus} is that shows how under some genetic and demographic scenarios (i.e., a large, randomly mating population in a constant environment) an ESS phenotype maybe independent of some genetic parameters like the recombination rate between the loci affecting the phenotype. Another example of this kind of result is the ``reduction principle'' of Feldman, Liberman, and colleagues \cite{Feldman:Liberman:1986,Liberman:Feldman:1986,Liberman:Feldman:1986a,Liberman:Feldman:1989,Altenberg:Liberman:2017}, which says that for large, randomly mating populations with viability selection in a constant environment, the only uninvadable or unbeatable rates of recombination, mutation, and migration are the lowest possible rates (typically zero). Like Result \ref{res:twolocus}, the reduction principle is proved by analyzing the external stability of an internally-stable equilibrium and calculating the invasion fitness of a rare mutant allele. However, alleles at the genetic locus where external stability is tested, which is called the modifier locus, do not directly affect fitness and instead modify rates of recombination, mutation, or migration. Given the connection between invasion fitness and ESS analysis, the reduction principle shows that rates of zero recombination, mutation, or migration are strict ESSs. In effect, the reduction principle says natural selection on populations at equilibrium in constant environments acts to reduce genetic and demographic processes that increase genetic variation; this is intuitive as such genetic variation must result in lower fitness genotypes since the population is already at an equilibrium and the environment is constant. Like Result \ref{res:twolocus}, the reduction principle holds independent of the recombination rate between the modifier locus and major loci that affect fitness.

In environments that are not constant, the reduction principle does not hold as genetic variation can be beneficial depending on the environmental state. Thus, natural selection may favor genetic and demographic mechanisms that generate genetic variation like positive rates of recombination, mutation, and migration. In fact, environmental variation, particularly over time, is one of the most well-studied and important factors supporting the evolution of genotypic and phenotypic variation through mechanisms that promote such variation like recombination \cite{Charlesworth:1976,Sasaki:Iwasa:1987,Otto:Michalakis:1998}, mutation \cite{Leigh:1970,Ishii:Matsuda:1989,Lachmann:Jablonka:1996}, migration \cite{Gillespie:1981,McPeek:Holt:1992,Blanquart:Gandon:2011}, phenotypic plasticity \cite{Caswell:1983,Via:Lande:1985,Gavrilets:Scheiner:1993,Jong:1995} and bet-hedging \cite{Slatkin:1974,Seger:Brockmann:1987,Kussell:Leibler:2005,Salathe:VanCleve:2009}. Recent work shows that not only are the ES recombination, mutation, and migration evolve rates positive in variable environments, but they also depends on genetic parameters like the recombination rate between the major and modifier loci. In the case of mutation rate evolution, \citeauthor{Liberman:VanCleve:2011} \cite{Liberman:VanCleve:2011} used an analysis of the external stability of the mutation rate to show that the ES mutation rate depends on the recombination rate between phenotypic locus and the modifier locus. For example, Figure \ref{fig:pip:switching}, shows pairwise invasibility plots for the mutation rate with different recombination rates and given weakly asymmetric selection in two different environments that alternate every $T=50$ generations. White regions are where mutant alleles with a switching rate on the vertical axis can invade a population with a resident rate given by the horizontal axis; black regions are when such a mutant cannot invade. The plots show that a rate of $~1/50$ is ES when the recombination rate is zero, similar to older results \cite{Leigh:1970,Lachmann:Jablonka:1996} that show the ES rate is $~1/T$. The ES switching rate decreases as recombination increases until there is an abrupt shift to an ES rate of zero switching. \citeauthor{Carja:Liberman:2014} \cite{Carja:Liberman:2014} generalize this approach to the evolution of recombination, mutation, and migration in fluctuating environments. They first show that the rate of environmental fluctuation has the same effect on ES recombination and migration rates as it does on ES mutation rates, namely that slower rates of fluctuation lead to slower recombination, mutation, and migration rates (see Figure 1 in \cite{Carja:Liberman:2014}). In other words, as the rate of environmental change slows, so do the ES rates of genetic and demographic processes that generate genetic variation. \citeauthor{Carja:Liberman:2014} also show that these ES rates all decrease with increasing rates of recombination between the major and modifier loci (see Figure S5 in \cite{Carja:Liberman:2014}). This can be understood as due to the fact that the strength of indirect selection at the modifier locus decreases as increased recombination erodes linkage disequilibrium between the major and modifier loci.

\section{Conclusions and the future of ESS analysis}

When Maynard Smith and Price \cite{Maynard-Smith:Price:1973,Maynard-Smith:1974} introduced ESS analysis, the revolutions in molecular genetics and genomics were still two and three decades off, respectively, and evolutionary biology was being roiled by questions and debates regarding the role of natural selection in the evolution of phenotypic novelty broadly \cite{Gould:Lewontin:1979} and in the evolution of animal and human behavior specifically \cite{Lewontin:1977,Hamilton:1977}. These debates drew sharp lines between proponents of evolutionary theory derived from explicit genetic and demographic assumptions and theories of phenotypic change based on natural selection alone, namely fitness optimization and ESS analysis. Even among those who agreed that ESS analysis was an important approach, questions remained about what measure of fitness to optimize, individual or inclusive fitness, and how to incorporate multilevel selection. In the decades following Maynard Smith and Price \cite{Maynard-Smith:Price:1973} however, mathematical analysis bridged some of the division by showing how ESSs can be viewed as the evolutionary attractors of a long-term evolutionary process that builds on short-term evolutionary change due to natural selection, mutation, recombination, and other evolutionary forces. Mathematical analysis of the long-term process also revealed that invasion fitness as a measure of external stability is the appropriate way to measure evolutionary success and that it can incorporate kin and group selection effects in group structured populations.

One of the initial goals of the long-term evolution approach was to determine the degree to which ESS analyses can be independent of the underlying genetics and demography of populations. Put another way, how justifiable is the phenotypic gambit? Result \ref{res:twolocus} shows that for large and randomly mating populations, ESSs can be fairly independent of genetic parameters like mutation and recombination rates and even the number of loci (for mixed ESSs; see \cite{Eshel:Feldman:1998,Eshel:Feldman:2001}). At the time, this independence was important for supporting the use of ESS analysis across a broad range of species with different genetics and demography. However, this independence may no longer be as useful given the growing abundance of genomic, transcriptomic, and long-term demographic data for natural populations. Instead, we might rather want to make use of these data to refine our evolutionary models, and the ESS may be a less useful approach if it cannot take advantage of these data. However, long-term evolution and consequently ESSs are in fact sensitive to genetics and demography for many traits and populations more complex than Result \ref{res:twolocus} assumes. The threshold for such complexity can be quite low as in the case of sex ratio evolution where details of the genetic system can be crucial \cite{Hamilton:1967,Eshel:Feldman:1982a,Wu:1983,Taylor:Jaenike:2002}, in the case of kin and group structured populations where demography determines the fate of genes with social effects, and in the case of recombination, mutation, and migration rate evolution in variable environments where the ES rates depend on the recombination rate between the major and modifier loci.

All of the ESS analysis so far as concerned a single phenotypic trait. However, the principle of invasion fitness can also be applied to multiple coevolving traits \cite{Leimar:2009,Mullon:Keller:2016,Mullon:Lehmann:2019}. When multiple phenotypes coevolve, issues of pleiotropy and genetic constraint immediately arise as mutations may not cause independent effects along the different phenotypic dimensions. Thus, even in the case of two coevolving phenotypes, genetic constraints due to the underlying genetic architecture can have strong effects on long-term evolution and the resulting ESSs. The study of coevolving phenotypes is nothing new to quantitative genetics \cite{Lande:1979,Lande:Arnold:1983,Phillips:Arnold:1989} where the important of genetic constrains has long been emphasized. In fact, recent work by \citeauthor{Mullon:Lehmann:2019} \cite{Mullon:Lehmann:2019} ties together the quantitative genetic and invasion fitness approaches for coevolving traits. By building from an invasion fitness perspective that is comfortable with fitness as a complex function of species ecology and behavior, this synthetic approach shows how pleiotropy, demography, and behavior can interact to shape the coevolution of two synergistic social traits \cite{Mullon:Lehmann:2019}.

Many conceptual divides in evolutionary theory have been bridged in recent decades including divides surrounding ESS analysis and its role in genotypic and phenotypic evolution and in kin and group selection. Given these advances, it is hard to be pessmistic about the prospect that evolutionary theory can tackle big open questions about the emergence and persistence of biodiversity. Even questions with global consequences like climate change, biodiversity loss, and global conflict may yet be advanced by a more unified evolutionary theory that can address the simultaneous action of genetic, phenotypic, social, and cultural change.

\section{Acknowledgements}

J.V.C. would like to acknowledge the hard work and extraordinary patience of the editors and staff who brought this special issue together.

\section{Funding}

This work was supported by National Science Foundation awards \#1846260 and \#1953223.

\clearpage
%\setlength{\bibitemsep}{1pt}
\printbibliography

\end{document}
